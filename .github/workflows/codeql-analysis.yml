name: "Create Issue on CodeQL Alert"

on:
  workflow_run:
    workflows: ["CodeQL Analysis for Go"]  # The name of your CodeQL workflow
    types:
      - completed

jobs:
  create_issue:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Get CodeQL Alerts
        uses: actions/github-script@v6
        with:
          script: |
            const alerts = await github.codeScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open"
            });

            for (const alert of alerts.data) {
              if (alert.rule.severity === "high" || alert.rule.severity === "critical") {
                const issueTitle = `CodeQL Alert: ${alert.rule.description}`;
                const issueBody = `**Rule:** ${alert.rule.name}\n**Severity:** ${alert.rule.severity}\n\n**Details:** ${alert.html_url}`;

                // Check if an issue for this alert already exists
                const issues = await github.issues.listForRepo({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open",
                  labels: "CodeQL Alert"
                });

                const existingIssue = issues.data.find(issue => issue.title === issueTitle);

                if (!existingIssue) {
                  // Create a new issue if one doesn't already exist
                  await github.issues.create({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    title: issueTitle,
                    body: issueBody,
                    labels: ["CodeQL Alert"]
                  });
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
